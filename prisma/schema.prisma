// Fort Homes QMS Database Schema
// SQLite for portable local development, can switch to PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Core document model for all QMS documents
model Document {
  id          String   @id @default(uuid())
  type        String   // 'manual' | 'sop' | 'wi' | 'form' | 'record'
  number      String   @unique // QM-001, SOP-001, WI-001, FORM-001
  title       String
  version     String
  status      String   // 'draft' | 'review' | 'approved' | 'obsolete'
  content     String   // JSON string of document content
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  approvedBy  String?
  approvedAt  DateTime?
  
  // Relations
  auditTrail  AuditTrail[]
  
  @@index([type, status])
  @@index([number])
}

// Audit trail for document changes
model AuditTrail {
  id          String   @id @default(uuid())
  documentId  String
  action      String   // 'create' | 'update' | 'approve' | 'archive'
  userId      String
  userName    String?
  timestamp   DateTime @default(now())
  changes     String   // JSON string of changes made
  
  // Relations
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([timestamp])
}

// Production procedure details
model Procedure {
  id                  String   @id @default(uuid())
  sopNumber           String   @unique
  phase               Int
  phaseDescription    String
  holdPoints          String   // JSON array of hold point IDs
  inspectionCriteria  String   // JSON array of criteria
  workActivities      String   // JSON array of activities
  tradeCrews          String   // JSON array of crews
  materials           String   // JSON array of materials
  equipment           String   // JSON array of equipment
  duration            String?
  bayAssignment       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([phase])
  @@index([sopNumber])
}

// Hold point inspections
model HoldPoint {
  id                String   @id @default(uuid())
  holdPointId       String   @unique // HP-1, HP-2, etc.
  phase             Int
  description       String
  inspectionType    String   // 'internal' | 'tpia' | 'customer'
  criteria          String   // JSON array of inspection criteria
  passConditions    String   // JSON array of pass conditions
  failActions       String   // JSON array of fail actions
  ntaRequired       Boolean  @default(false)
  notificationDays  Int      @default(2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([phase])
  @@index([holdPointId])
}

// Nonconformance records
model NCR {
  id                String   @id @default(uuid())
  ncrNumber         String   @unique
  moduleNumber      String?
  phase             Int?
  description       String
  severity          String   // 'critical' | 'major' | 'minor'
  detectedBy        String
  detectedDate      DateTime
  status            String   // 'open' | 'in-progress' | 'resolved' | 'closed'
  rootCause         String?
  correctiveAction  String?
  resolvedBy        String?
  resolvedDate      DateTime?
  verifiedBy        String?
  verifiedDate      DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([status])
  @@index([ncrNumber])
  @@index([detectedDate])
}

// Training records
model TrainingRecord {
  id              String   @id @default(uuid())
  employeeId      String
  employeeName    String
  trainingType    String   // 'initial' | 'refresher' | 'ojtw' | 'specialized'
  sopNumber       String?
  phase           Int?
  trainingDate    DateTime
  trainer         String
  assessmentScore Int?     // 0-100
  passed          Boolean  @default(false)
  expiryDate      DateTime?
  certificateUrl  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@index([sopNumber])
  @@index([trainingDate])
}

// Quality metrics and KPIs
model QualityMetric {
  id            String   @id @default(uuid())
  metricType    String   // 'first-pass-yield' | 'ncr-rate' | 'inspection-pass-rate' | 'cycle-time'
  phase         Int?
  period        String   // 'weekly' | 'monthly' | 'quarterly'
  periodStart   DateTime
  periodEnd     DateTime
  value         Float
  target        Float
  unit          String
  notes         String?
  createdAt     DateTime @default(now())
  
  @@index([metricType])
  @@index([periodStart])
}

// Supplier/vendor records
model Supplier {
  id                String   @id @default(uuid())
  supplierCode      String   @unique
  name              String
  category          String   // 'lumber' | 'electrical' | 'plumbing' | 'hvac' | 'windows' | 'other'
  status            String   // 'approved' | 'conditional' | 'suspended'
  approvalDate      DateTime?
  certifications    String   // JSON array of certifications
  contactInfo       String   // JSON object with contact details
  qualityRating     Float?   // 0-100
  lastAuditDate     DateTime?
  nextAuditDate     DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([status])
  @@index([supplierCode])
}
